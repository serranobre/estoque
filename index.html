<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESTOQUE — PWA</title>

  <!-- Mantém os mesmos arquivos do app de pedidos -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-title" content="Serra Nobre" />
  <meta name="theme-color" content="#f1f5f9" />

  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --muted:#64748b; --ink:#0f172a; --line:#e2e8f0;

      /* Paletas por família (soft/strong) */
      --fam0-soft:#eef2ff;  --fam0-strong:#6366f1;  /* BOVINO GANCHO   */
      --fam1-soft:#ecfeff;  --fam1-strong:#06b6d4;  /* BOVINO CORTES   */
      --fam2-soft:#f0fdf4;  --fam2-strong:#22c55e;  /* CAIXARIAS       */
      --fam3-soft:#fffbeb;  --fam3-strong:#f59e0b;  /* CORDEIRO        */
      --fam4-soft:#fef2f2;  --fam4-strong:#ef4444;  /* EMBUTIDOS       */
      --fam5-soft:#fdf4ff;  --fam5-strong:#a855f7;  /* FRANGO          */
      --fam6-soft:#f1f5f9;  --fam6-strong:#334155;  /* MIUDOS          */
      --fam7-soft:#fff1f2;  --fam7-strong:#f43f5e;  /* PEIXE           */
      --fam8-soft:#f2f9f5;  --fam8-strong:#10b981;  /* QUEIJOS         */
      --fam9-soft:#f5f3ff;  --fam9-strong:#7c3aed;  /* SUINO           */
      --fam10-soft:#f0f9ff; --fam10-strong:#0ea5e9; /* extra           */
      --fam11-soft:#fefce8; --fam11-strong:#eab308; /* extra           */
    }

    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:var(--bg);color:var(--ink)
    }

    header{
      position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);
      padding:12px 16px;display:flex;gap:8px;align-items:center;z-index:10;
      overflow-x:auto; white-space:nowrap;
    }
    header h1{font-size:18px;margin:0;letter-spacing:.5px}
    header .spacer{flex:1}
    button,input,select{font:inherit}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.ghost{background:transparent}

    /* Barra de sync */
    .syncbar{
      position:sticky; top:48px; z-index:9; display:none;
      padding:8px 12px; background:#fffbeb; border-bottom:1px solid #f5e7b3; color:#7a5d00;
      font-size:13px; display:flex; align-items:center; gap:8px
    }
    .syncbar.show{ display:flex }
    .spinner{ width:12px; height:12px; border:2px solid #eab308; border-top-color:transparent; border-radius:50%; animation:spin .9s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .syncbar.error{ background:#fef2f2; border-color:#fecaca; color:#991b1b }

    .wrap{max-width:980px;margin:12px auto 20px;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;
          box-shadow:0 1px 0 rgba(15,23,42,.03);margin-bottom:16px;overflow:hidden}

    /* Cabeçalho da família = FAIXA INTEIRA na cor forte */
    .fam-head{
      display:flex;align-items:center;gap:10px;padding:12px 14px;
      color:#fff;border-bottom:1px solid var(--line);cursor:pointer;flex-wrap:wrap
    }
    .fam-title{font-weight:900;letter-spacing:.6px;font-size:18px}
    .fam-meta{margin-left:auto;font-size:12px;opacity:.95;color:#fff;width:100%}

    .fam-body{padding:0 12px 10px;display:none}
    .fam-body.open{display:block}

    /* ====== LINHAS DE ITEM — GRID COM ÁREAS ====== */
    .row{
      display:grid;
      grid-template-columns: 1.2fr auto 1fr auto auto; /* desktop */
      grid-template-areas:
        "name chips qty add actions"
        "feedback feedback feedback feedback feedback"
        "editor editor editor editor editor";
      gap:8px;
      padding:10px 8px;
      border-bottom:1px dashed var(--line);
      align-items:center;
      font-size:16px;
    }
    .cell-name   { grid-area: name;   font-weight:700; text-transform:uppercase }
    .cell-chips  { grid-area: chips;  display:flex; gap:8px; flex-wrap:wrap }
    .cell-qty    { grid-area: qty;    display:flex; gap:6px; align-items:center }
    .cell-qty input{ width:120px; padding:10px; border:1px solid var(--line); border-radius:10px }
    .cell-qty select.unit{ width:70px; padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff }
    .cell-add    { grid-area: add; }
    .cell-actions{ grid-area: actions; display:flex; gap:6px; justify-content:flex-end }
    .feedback    { grid-area: feedback; font-size:12px; color:#0f172a; padding:6px 2px 10px; min-height:18px; line-height:1.25 }
    .editor      { grid-area: editor; display:none; padding:10px; border:1px dashed var(--line); border-radius:10px; background:#fff }
    .editor.open { display:block }
    .editor .grid{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr auto auto; gap:8px }
    .editor input{ width:100%; padding:10px; border:1px solid var(--line); border-radius:10px }

    .chip-opt{border:1px solid var(--line);padding:8px 12px;border-radius:999px;background:#fff;cursor:pointer;user-select:none}
    .chip-opt.active{border-color:#111827;background:#111827;color:#fff}

    .pill{background:#fff;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .footer-actions{
      position:sticky;bottom:0;background:linear-gradient(to top,#ffffff,#ffffffe6 70%,transparent);
      padding:12px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:center
    }

    /* Alternância: usa o TOM SUAVE da própria família */
    .fam-0 .fam-body .row:nth-child(even){background:var(--fam0-soft)}
    .fam-1 .fam-body .row:nth-child(even){background:var(--fam1-soft)}
    .fam-2 .fam-body .row:nth-child(even){background:var(--fam2-soft)}
    .fam-3 .fam-body .row:nth-child(even){background:var(--fam3-soft)}
    .fam-4 .fam-body .row:nth-child(even){background:var(--fam4-soft)}
    .fam-5 .fam-body .row:nth-child(even){background:var(--fam5-soft)}
    .fam-6 .fam-body .row:nth-child(even){background:var(--fam6-soft)}
    .fam-7 .fam-body .row:nth-child(even){background:var(--fam7-soft)}
    .fam-8 .fam-body .row:nth-child(even){background:var(--fam8-soft)}
    .fam-9 .fam-body .row:nth-child(even){background:var(--fam9-soft)}
    .fam-10 .fam-body .row:nth-child(even){background:var(--fam10-soft)}
    .fam-11 .fam-body .row:nth-child(even){background:var(--fam11-soft)}

    /* Aplicar cor forte no cabeçalho por família */
    .fam-0 .fam-head{background:var(--fam0-strong)}
    .fam-1 .fam-head{background:var(--fam1-strong)}
    .fam-2 .fam-head{background:var(--fam2-strong)}
    .fam-3 .fam-head{background:var(--fam3-strong)}
    .fam-4 .fam-head{background:var(--fam4-strong)}
    .fam-5 .fam-head{background:var(--fam5-strong)}
    .fam-6 .fam-head{background:var(--fam6-strong)}
    .fam-7 .fam-head{background:var(--fam7-strong)}
    .fam-8 .fam-head{background:var(--fam8-strong)}
    .fam-9 .fam-head{background:var(--fam9-strong)}
    .fam-10 .fam-head{background:var(--fam10-strong)}
    .fam-11 .fam-head{background:var(--fam11-strong)}

    /* MOBILE */
    @media (max-width:480px){
      .row{
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "name name"
          "chips chips"
          "qty add"
          "actions actions"
          "feedback feedback"
          "editor editor";
      }
      .cell-qty input{ width:100% }
      .cell-qty select.unit{ width:100% }
      header h1{font-size:16px}
    }
  </style>
</head>
<body>
  <header>
    <h1>CONTROLE DE ESTOQUE</h1>
    <div class="spacer"></div>
    <button class="btn" id="btnLimpar">Zerar</button>
    <button class="btn" id="btnExportar">Gerar PDF</button>
    <button class="btn primary" id="btnCompartilhar">Compartilhar PDF</button>
  </header>

  <!-- Barra de sincronização -->
  <div id="syncbar" class="syncbar"><div class="spinner"></div><span id="syncmsg">Sincronizando com o servidor…</span></div>

  <div class="wrap" id="app"></div>

  <div class="footer-actions">
    <span class="pill">Dados salvos no dispositivo • Sincronizado com Firebase</span>
  </div>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- ========= FIREBASE (ESM CDN) ========= -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import {
      getFirestore, serverTimestamp, doc, runTransaction,
      collection, addDoc, getDocs
    } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

    // Config do teu projeto
    const firebaseConfig = {
      apiKey: "AIzaSyBqpEQ9BX9ns655eH4hPHdEwIop0gCPEzI",
      authDomain: "estoque-serra-nobre.firebaseapp.com",
      projectId: "estoque-serra-nobre",
      storageBucket: "estoque-serra-nobre.appspot.com",
      messagingSenderId: "513208551190",
      appId: "1:513208551190:web:4c7165b7887290193a7237"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await signInAnonymously(auth);

    const invId = (family, product) =>
      `${family}__${product}`.toUpperCase().replace(/\s+/g,' ').trim();

    async function fbAddQuantity({ family, product, tipo, unit, qty }){
      const id = invId(family, product);
      const ref = doc(db, 'inventory', id);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        let data = snap.exists() ? snap.data() : {
          family: family.toUpperCase(),
          product: product.toUpperCase(),
          resfriado_kg: 0, resfriado_cx: 0,
          congelado_kg: 0, congelado_cx: 0
        };
        const field =
          tipo === 'RESFRIADO'
            ? (unit==='KG' ? 'resfriado_kg' : 'resfriado_cx')
            : (unit==='KG' ? 'congelado_kg' : 'congelado_cx');
        data[field] = +(data[field]||0) + qty;
        data.updated_at = serverTimestamp();
        tx.set(ref, data, { merge:true });
      });
      await addDoc(collection(db,'history'),{
        family: family.toUpperCase(),
        product: product.toUpperCase(),
        tipo, unit, qty, action:'ADD',
        at: serverTimestamp(), source:'pwa-estoque'
      });
    }

    async function fbEditAbsolute({ family, product, resfriado_kg, resfriado_cx, congelado_kg, congelado_cx }){
      const id = invId(family, product);
      const ref = doc(db, 'inventory', id);
      await runTransaction(db, async (tx)=>{
        const cur = (await tx.get(ref)).data() || {family,product,resfriado_kg:0,resfriado_cx:0,congelado_kg:0,congelado_cx:0};
        const next = {
          ...cur,
          family: family.toUpperCase(),
          product: product.toUpperCase(),
          resfriado_kg:+resfriado_kg||0, resfriado_cx:+resfriado_cx||0,
          congelado_kg:+congelado_kg||0, congelado_cx:+congelado_cx||0,
          updated_at: serverTimestamp()
        };
        tx.set(ref, next, { merge:true });
      });
      await addDoc(collection(db,'history'),{
        family: family.toUpperCase(),
        product: product.toUpperCase(),
        action:'EDIT_ABS',
        at: serverTimestamp(), source:'pwa-estoque'
      });
    }

    async function fbZeroItem({ family, product }){
      const id = invId(family, product);
      const ref = doc(db, 'inventory', id);
      await runTransaction(db, async (tx)=>{
        const cur = (await tx.get(ref)).data() || {};
        const next = {
          ...cur,
          resfriado_kg:0, resfriado_cx:0, congelado_kg:0, congelado_cx:0,
          updated_at: serverTimestamp()
        };
        tx.set(ref, next, { merge:true });
      });
      await addDoc(collection(db,'history'),{
        family: family.toUpperCase(), product: product.toUpperCase(),
        action:'ZERO', at: serverTimestamp(), source:'pwa-estoque'
      });
    }

    async function fbLogDeleteCustom({ family, product }){
      await addDoc(collection(db,'history'),{
        family: family.toUpperCase(), product: product.toUpperCase(),
        action:'DELETE_CUSTOM', at: serverTimestamp(), source:'pwa-estoque'
      });
    }

    // 🔎 fetch agregados da coleção inventory
    async function fbFetchAllInventory(){
      const snap = await getDocs(collection(db, 'inventory'));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // expõe para o script principal
    window.__fb = { fbAddQuantity, fbEditAbsolute, fbZeroItem, fbLogDeleteCustom, fbFetchAllInventory };
  </script>

  <!-- ========= APP ========= -->
  <script>
    /* ===== LOGO (auto base64 de 'Serra-Nobre_3.*') ===== */
    const LOGO_KEY = 'estoque_logo_b64';
    const LOGO_FILE_ORDER = ['Serra-Nobre_3.png','Serra-Nobre_3.webp','Serra-Nobre_3.jpg','Serra-Nobre_3.jpeg'];
    let logoB64 = localStorage.getItem(LOGO_KEY) || null;
    async function blobToB64(blob){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(blob);});}
    async function fetchAsB64(url){try{const r=await fetch(url,{cache:'no-store'});if(!r.ok)throw 0;return await blobToB64(await r.blob());}catch{return null;}}
    async function ensureLogoB64(){ if(logoB64) return; for(const f of LOGO_FILE_ORDER){ const b=await fetchAsB64(f); if(b){ logoB64=b; localStorage.setItem(LOGO_KEY,b); break; } } }

    /* ===== Dados das famílias ===== */
    const FAMILIAS = [
      { nome:"BOVINO GANCHO", itens:["CASADO GANCHO","DIANTEIRO GANCHO","COSTELA GANCHO","CHULETA GANCHO","COXA GANCHO"]},
      { nome:"BOVINO CORTES", itens:["ALCATRA","CARNE CABEÇA","CHULETA PRONTA","COXÃO DURO","COXÃO MOLE","MAMINHA","RETALHO OU NABA","VAZIO"]},
      { nome:"CAIXARIAS", itens:["CAPA DO COXÃO","COSTELA","COXAO FORA","COXAO MOLE","PATINHO","VAZIO"]},
      { nome:"CORDEIRO", itens:["CARRÉ","COSTELA","PERNIL","PALETA","FILEZINHO"]},
      { nome:"EMBUTIDOS", itens:["BACON FATIADO","BACON MANTA","BOLINHA BORRUSSIA","CALABRESA FATIADA","CALABRESA MIGNON","CALABRESA TORTA","FRESCAL C/ PIMENTA","FRESCAL S/ PIMENTA","JUBOIA BORRUSIA","SALAME CURTO","SALAME NORMAL","SALSICHAO BORRUSSIA","SALSICHAO COLONIAL"]},
      { nome:"FRANGO", itens:["CORAÇÃO DE FRANGO","COXA DE FRANGO","COXA E SOBRECOXA DE FRANGO","COXA E SOBRECOXA DORSAL FRANGO","COXINHA DE FRANGO","FILE DE PEITO DE FRANGO","FRANGO INTEIRO","GALINHA VELHA","MOELA DE FRANGO","PEITO DE FRANGO COM OSSO","SOBRECOXA DE FRANGO","TULIPA DE FRANGO"]},
      { nome:"MIUDOS", itens:["CORAÇÃO BOVINO","FIGADO BOVINO","LINGUA BOVINA","RABADA BOVINA","CORAÇÃO SUINO","ORELHA SUINA","PEZINHO SUINO","RABINHO SUINO"]},
      { nome:"PEIXE", itens:["PANGA","PESCADO"]},
      { nome:"QUEIJOS", itens:["QUEIJO FATIADO","QUEIJO INTEIRO","QUEIJO COLONIAL","QUEIJO COALHO PEÇA","QUEIJO COALHO PALITO"]},
      { nome:"SUINO", itens:["CARRE SUINO","COSTELINHA SUINA","FILEZINHO SUINO","PALETA SUINA","PERNIL SUINO","SOBREPALETA SUINA"]},
    ];
    const PADROES = Object.fromEntries(FAMILIAS.map(f => [f.nome, new Set(f.itens)]));
    const TIPOS = ["RESFRIADO","CONGELADO"];

    /* ===== Persistência local ===== */
    const STORAGE_KEY = "estoque_pwa_v3";
    function loadStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch{ return {} } }
    function saveStore(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
    let store = loadStore();
    for(const fam of FAMILIAS){
      store[fam.nome] ??= {};
      for(const p of fam.itens) store[fam.nome][p] ??= { RESFRIADO:0, RESFRIADO_CX:0, CONGELADO:0, CONGELADO_CX:0 };
    }
    saveStore(store);

    /* ===== Helpers ===== */
    const $$ = s=>document.querySelector(s);
    const fmt = n => (Math.round(n*1000)/1000).toLocaleString('pt-BR',{minimumFractionDigits:3,maximumFractionDigits:3});
    const round3 = n => Math.round(n*1000)/1000;

    function displayUnit(family, unit){ return (family === 'BOVINO GANCHO' && unit === 'CX') ? 'UN' : unit; }
    function familiaCxLabel(family){ return family === 'BOVINO GANCHO' ? 'UN' : 'CX'; }
    function formatFamiliaMeta(family){
      const d = store[family] || {};
      let rkg=0, rcx=0, ckg=0, ccx=0;
      Object.values(d).forEach(v=>{
        rkg += v.RESFRIADO||0;  rcx += v.RESFRIADO_CX||0;
        ckg += v.CONGELADO||0;  ccx += v.CONGELADO_CX||0;
      });
      const cx = familiaCxLabel(family);
      return `RESF: ${fmt(rkg)} KG / ${rcx} ${cx} • CONG: ${fmt(ckg)} KG / ${ccx} ${cx}`;
    }

    function renderHeaderMeta(familia){
      document.querySelectorAll('.card').forEach(section=>{
        if(section.querySelector('.fam-title')?.textContent===familia){
          section.querySelector('.fam-meta').textContent = formatFamiliaMeta(familia);
        }
      });
    }

    /* ===== UI ===== */
    function render(){
      const app = $$('#app'); app.innerHTML='';
      FAMILIAS.forEach((fam, idx)=>{
        const card = document.createElement('section'); card.className=`card fam-${idx}`;
        const head = document.createElement('div'); head.className='fam-head';
        const title = document.createElement('div'); title.className='fam-title'; title.textContent=fam.nome;
        const meta = document.createElement('div'); meta.className='fam-meta'; meta.textContent = formatFamiliaMeta(fam.nome);
        head.append(title, meta);
        const body = document.createElement('div'); body.className='fam-body open';
        head.addEventListener('click',()=>body.classList.toggle('open'));

        const itensFamilia = Object.keys(store[fam.nome]||{});
        const ordenados = [...new Set([...fam.itens, ...itensFamilia])];
        ordenados.forEach(prod => body.appendChild(rowProduto(fam.nome, prod)));
        body.appendChild(divider());
        body.appendChild(rowNovoProduto(fam.nome));

        card.append(head, body); app.appendChild(card);
      });
    }
    function divider(){ const d=document.createElement('div'); d.className='divider'; return d; }

    function rowProduto(familia, produto){
      store[familia] ??= {};
      store[familia][produto] ??= { RESFRIADO:0, RESFRIADO_CX:0, CONGELADO:0, CONGELADO_CX:0 };

      const wrap = document.createElement('div'); wrap.className='row';

      const name = document.createElement('div'); name.className='cell-name'; name.textContent=produto;

      const chips = document.createElement('div'); chips.className='cell-chips';
      const optR = document.createElement('div'); optR.className='chip-opt'; optR.textContent='RESFRIADO';
      const optC = document.createElement('div'); optC.className='chip-opt'; optC.textContent='CONGELADO';
      chips.append(optR,optC);
      let selTipo='RESFRIADO';
      const setSel = t => { selTipo=t; optR.classList.toggle('active', t==='RESFRIADO'); optC.classList.toggle('active', t==='CONGELADO'); };
      setSel('RESFRIADO'); optR.onclick=()=>setSel('RESFRIADO'); optC.onclick=()=>setSel('CONGELADO');

      const qty = document.createElement('div'); qty.className='cell-qty';
      const unit = document.createElement('select'); unit.className='unit'; unit.innerHTML='<option>KG</option><option>CX</option>';
      const inp  = document.createElement('input'); inp.type='number'; inp.step='0.001'; inp.min='0'; inp.placeholder='Peso (kg/cx)';
      qty.append(unit, inp);

      const add = document.createElement('button'); add.className='btn cell-add'; add.textContent='Adicionar';

      const actions = document.createElement('div'); actions.className='cell-actions';
      const btnEdit = document.createElement('button'); btnEdit.className='btn ghost'; btnEdit.textContent='Editar';
      const btnDel  = document.createElement('button'); btnDel.className='btn ghost';  btnDel.textContent='Excluir';
      actions.append(btnEdit, btnDel);

      const feedback = document.createElement('div'); feedback.className='feedback';

      const editor = document.createElement('div'); editor.className='editor';
      const grid = document.createElement('div'); grid.className='grid';
      const inResfKg = document.createElement('input'); inResfKg.type='number'; inResfKg.step='0.001'; inResfKg.min='0'; inResfKg.placeholder='RESF (KG)';
      const inResfCx = document.createElement('input'); inResfCx.type='number'; inResfCx.step='1';     inResfCx.min='0'; inResfCx.placeholder='RESF (CX/UN)';
      const inCongKg = document.createElement('input'); inCongKg.type='number'; inCongKg.step='0.001'; inCongKg.min='0'; inCongKg.placeholder='CONG (KG)';
      const inCongCx = document.createElement('input'); inCongCx.type='number'; inCongCx.step='1';     inCongCx.min='0'; inCongCx.placeholder='CONG (CX/UN)';
      const bSalvar  = document.createElement('button'); bSalvar.className='btn primary'; bSalvar.textContent='Salvar';
      const bCancel  = document.createElement('button'); bCancel.className='btn';         bCancel.textContent='Cancelar';
      grid.append(inResfKg,inResfCx,inCongKg,inCongCx,bSalvar,bCancel); editor.appendChild(grid);

      function openEditor(){
        const cur = store[familia][produto];
        inResfKg.value = (cur.RESFRIADO || 0).toString().replace('.',',');
        inResfCx.value = (cur.RESFRIADO_CX || 0);
        inCongKg.value = (cur.CONGELADO || 0).toString().replace('.',',');
        inCongCx.value = (cur.CONGELADO_CX || 0);
        editor.classList.add('open');
      }
      const closeEditor = ()=> editor.classList.remove('open');

      btnEdit.addEventListener('click', openEditor);
      bCancel.addEventListener('click', closeEditor);

      bSalvar.addEventListener('click', async ()=>{
        const nrkg = parseFloat((inResfKg.value||'0').replace(',','.'))||0;
        const nrcx = parseInt(inResfCx.value||'0')||0;
        const nckg = parseFloat((inCongKg.value||'0').replace(',','.'))||0;
        const nccx = parseInt(inCongCx.value||'0')||0;

        store[familia][produto] = { RESFRIADO: round3(nrkg), RESFRIADO_CX: nrcx, CONGELADO: round3(nckg), CONGELADO_CX: nccx };
        saveStore(store);
        renderHeaderMeta(familia);
        feedback.textContent = `Atualizado: RESF ${fmt(nrkg)} kg / ${nrcx} ${familiaCxLabel(familia)} • CONG ${fmt(nckg)} kg / ${nccx} ${familiaCxLabel(familia)}`;

        if (window.__fb?.fbEditAbsolute) {
          await window.__fb.fbEditAbsolute({
            family: familia, product: produto,
            resfriado_kg: nrkg, resfriado_cx: nrcx, congelado_kg: nckg, congelado_cx: nccx
          });
        }
        closeEditor();
      });

      btnDel.addEventListener('click', async ()=>{
        const isPadrao = PADROES[familia]?.has(produto);
        if(isPadrao){
          if(confirm('Item padrão: deseja zerar os totais?')){
            store[familia][produto] = { RESFRIADO:0, RESFRIADO_CX:0, CONGELADO:0, CONGELADO_CX:0 };
            saveStore(store); renderHeaderMeta(familia);
            feedback.textContent = 'Totais zerados.';
            if(window.__fb?.fbZeroItem){ await window.__fb.fbZeroItem({ family: familia, product: produto }); }
          }
        }else{
          if(confirm('Remover item personalizado?')){
            delete store[familia][produto];
            saveStore(store); wrap.remove(); renderHeaderMeta(familia);
            if(window.__fb?.fbLogDeleteCustom){ await window.__fb.fbLogDeleteCustom({ family: familia, product: produto }); }
          }
        }
      });

      add.addEventListener('click', async ()=>{
        const val = parseFloat((inp.value||'').replace(',','.'));
        if(isNaN(val) || val<=0){ alert('Informe um peso válido (> 0).'); return; }
        const u = unit.value; // 'KG' | 'CX'
        const uLabel = displayUnit(familia, u);

        const cur = store[familia][produto];
        if(selTipo==='RESFRIADO'){
          if(u==='KG') cur.RESFRIADO = round3((cur.RESFRIADO||0) + val);
          else         cur.RESFRIADO_CX = (cur.RESFRIADO_CX||0) + Math.round(val);
        }else{
          if(u==='KG') cur.CONGELADO = round3((cur.CONGELADO||0) + val);
          else         cur.CONGELADO_CX = (cur.CONGELADO_CX||0) + Math.round(val);
        }
        saveStore(store); renderHeaderMeta(familia);

        feedback.textContent =
          `Adicionado: ${fmt(val)} ${uLabel} • ${selTipo}. `
          + `Totais — RESF ${fmt(cur.RESFRIADO||0)} kg / ${cur.RESFRIADO_CX||0} ${familiaCxLabel(familia)} `
          + `• CONG ${fmt(cur.CONGELADO||0)} kg / ${cur.CONGELADO_CX||0} ${familiaCxLabel(familia)}`;

        inp.value='';

        if(window.__fb?.fbAddQuantity){
          await window.__fb.fbAddQuantity({
            family: familia, product: produto, tipo: selTipo, unit: u, qty: (u==='KG'? val : Math.round(val))
          });
        }
      });

      wrap.append(name, chips, qty, add, actions, feedback, editor);
      return wrap;
    }

    function rowNovoProduto(familia){
      const wrap = document.createElement('div'); wrap.className='row';
      const name = document.createElement('input'); name.placeholder='Novo produto (CAIXA ALTA)'; name.style.textTransform='uppercase';

      const chips = document.createElement('div'); chips.className='cell-chips';
      const optR = document.createElement('div'); optR.className='chip-opt'; optR.textContent='RESFRIADO';
      const optC = document.createElement('div'); optC.className='chip-opt'; optC.textContent='CONGELADO';
      chips.append(optR,optC);
      let selTipo='RESFRIADO'; const setSel=t=>{ selTipo=t; optR.classList.toggle('active',t==='RESFRIADO'); optC.classList.toggle('active',t==='CONGELADO'); };
      setSel('RESFRIADO'); optR.onclick=()=>setSel('RESFRIADO'); optC.onclick=()=>setSel('CONGELADO');

      const qty = document.createElement('div'); qty.className='cell-qty';
      const unit = document.createElement('select'); unit.className='unit'; unit.innerHTML='<option>KG</option><option>CX</option>';
      const inp  = document.createElement('input'); inp.type='number'; inp.step='0.001'; inp.min='0'; inp.placeholder='Peso (kg/cx)';
      qty.append(unit, inp);

      const add = document.createElement('button'); add.className='btn cell-add'; add.textContent='Adicionar';
      const spacer = document.createElement('div'); spacer.className='cell-actions';
      const feedback = document.createElement('div'); feedback.className='feedback';

      add.addEventListener('click', async ()=>{
        const prod = (name.value||'').trim().toUpperCase();
        const val  = parseFloat((inp.value||'').replace(',','.'));
        if(!prod){ alert('Digite o nome do produto.'); return; }
        if(isNaN(val)||val<=0){ alert('Informe um peso válido (> 0).'); return; }

        const u = unit.value; const uLabel = displayUnit(familia, u);
        store[familia] ??= {};
        const cur = store[familia][prod] ??= {RESFRIADO:0, RESFRIADO_CX:0, CONGELADO:0, CONGELADO_CX:0};

        if(selTipo==='RESFRIADO'){
          if(u==='KG') cur.RESFRIADO = round3(cur.RESFRIADO + val);
          else         cur.RESFRIADO_CX = (cur.RESFRIADO_CX||0) + Math.round(val);
        }else{
          if(u==='KG') cur.CONGELADO = round3(cur.CONGELADO + val);
          else         cur.CONGELADO_CX = (cur.CONGELADO_CX||0) + Math.round(val);
        }
        saveStore(store);

        const parent = wrap.parentElement;
        parent.insertBefore(rowProduto(familia, prod), wrap);
        renderHeaderMeta(familia);

        feedback.textContent = `Adicionado: ${fmt(val)} ${uLabel} • ${selTipo} em ${prod}`;
        name.value=''; inp.value='';

        if(window.__fb?.fbAddQuantity){
          await window.__fb.fbAddQuantity({
            family: familia, product: prod, tipo: selTipo, unit: u, qty: (u==='KG'? val : Math.round(val))
          });
        }
      });

      const cellNameWrap = document.createElement('div'); cellNameWrap.className='cell-name'; cellNameWrap.appendChild(name);
      wrap.append(cellNameWrap, chips, qty, add, spacer, feedback);
      return wrap;
    }

    /* ===== PDF ===== */
    const PALETAS = [
      {soft:'#eef2ff', strong:'#6366f1'},
      {soft:'#ecfeff', strong:'#06b6d4'},
      {soft:'#f0fdf4', strong:'#22c55e'},
      {soft:'#fffbeb', strong:'#f59e0b'},
      {soft:'#fef2f2', strong:'#ef4444'},
      {soft:'#fdf4ff', strong:'#a855f7'},
      {soft:'#f1f5f9', strong:'#334155'},
      {soft:'#fff1f2', strong:'#f43f5e'},
      {soft:'#f2f9f5', strong:'#10b981'},
      {soft:'#f5f3ff', strong:'#7c3aed'},
      {soft:'#f0f9ff', strong:'#0ea5e9'},
      {soft:'#fefce8', strong:'#eab308'},
    ];
    const hex2rgb = hex => { const h=hex.replace('#',''); return {r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16)} };

    async function gerarPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      const W = doc.internal.pageSize.getWidth();
      const margin = 36;
      let y = margin;

      // Cabeçalho
      if(logoB64){
        const isJPEG = logoB64.startsWith('data:image/jpeg') || logoB64.startsWith('data:image/jpg');
        const imgType = isJPEG ? 'JPEG' : 'PNG';
        doc.addImage(logoB64, imgType, margin, y-10, 64, 64);
      }
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('ESTOQUE DO DIA', W/2, y+8, {align:'center'});
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(new Date().toLocaleString('pt-BR'), W/2, y+24, {align:'center'});
      y += 40;

      for(let i=0;i<FAMILIAS.length;i++){
        const fam = FAMILIAS[i].nome;
        const itens = Object.keys(store[fam]||{}).filter(p=>{
          const v = store[fam][p]||{};
          return (v.RESFRIADO||0) > 0 || (v.CONGELADO||0) > 0 || (v.RESFRIADO_CX||0) > 0 || (v.CONGELADO_CX||0) > 0;
        });
        if(itens.length===0) continue;

        if(y > 740){ doc.addPage(); y = margin; }

        const soft = hex2rgb(PALETAS[i%PALETAS.length].soft);
        const strong = hex2rgb(PALETAS[i%PALETAS.length].strong);

        // Faixa família
        doc.setFillColor(soft.r,soft.g,soft.b);
        doc.rect(margin, y, W - margin*2, 24, 'F');
        doc.setTextColor(strong.r,strong.g,strong.b);
        doc.setFont('helvetica','bold'); doc.setFontSize(18);
        doc.text(fam, W/2, y+16, {align:'center'});
        doc.setTextColor(0,0,0);

        y += 40; // espaço MAIOR antes do cabeçalho

        // Cabeçalho tabela
        const cxLbl = familiaCxLabel(fam);
        doc.setFont('helvetica','bold'); doc.setFontSize(10);
        doc.text('PRODUTO', margin, y);
        doc.text(`RESFRIADO (KG / ${cxLbl})`, margin+320, y, {align:'right'});
        doc.text(`CONGELADO (KG / ${cxLbl})`, margin+520, y, {align:'right'});
        y += 12;
        doc.setDrawColor(200); doc.line(margin, y, W - margin, y);
        y += 8; // baixa início dos itens (sem sobreposição)

        doc.setFont('helvetica','normal'); doc.setFontSize(9);
        let frkg=0, frcx=0, fckg=0, fccx=0;

        let row = 0;
        for(const p of itens.sort()){
          const v = store[fam][p];
          if(y > 780){ doc.addPage(); y = margin; row = 0; }

          // zebra cinza
          if(row % 2 === 1){
            doc.setFillColor(240,240,240);
            doc.rect(margin, y-10, W - margin*2, 16, 'F');
          }

          doc.text(p, margin, y);
          doc.text(`${fmt(v.RESFRIADO||0)} / ${v.RESFRIADO_CX||0}`, margin+320, y, {align:'right'});
          doc.text(`${fmt(v.CONGELADO||0)} / ${v.CONGELADO_CX||0}`, margin+520, y, {align:'right'});
          y += 16; row++;
          frkg += v.RESFRIADO||0; frcx += v.RESFRIADO_CX||0;
          fckg += v.CONGELADO||0; fccx += v.CONGELADO_CX||0;
        }

        y += 2; doc.setFont('helvetica','bold'); doc.setFontSize(10);
        doc.text('TOTAL', margin, y);
        doc.text(`${fmt(frkg)} / ${frcx}`, margin+320, y, {align:'right'});
        doc.text(`${fmt(fckg)} / ${fccx}`, margin+520, y, {align:'right'});
        doc.setFont('helvetica','normal'); doc.setFontSize(9);
        y += 14;
      }

      return doc.output('blob');
    }

    async function abrirPDFEmAba(blob){
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      setTimeout(()=>URL.revokeObjectURL(url), 60000);
    }
    async function acaoGerar(){ await ensureLogoB64(); const blob = await gerarPDF(); await abrirPDFEmAba(blob); }
    async function acaoCompartilhar(){
      await ensureLogoB64();
      const blob = await gerarPDF();
      await abrirPDFEmAba(blob);
      const file = new File([blob], `ESTOQUE_${new Date().toISOString().slice(0,10)}.pdf`, {type:'application/pdf'});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        try{ await navigator.share({ files:[file], title:'Estoque', text:'Relatório de estoque' }); }catch(e){}
      }
    }

    /* ===== SYNC PROFISSIONAL (server-wins com backoff, timeout e validação) ===== */
    const SYNC_META_KEY = 'estoque_sync_meta';
    function setSyncBar(state, msg){
      const bar=$$('#syncbar'); const m=$$('#syncmsg');
      if(!bar||!m) return;
      bar.classList.remove('error');
      if(state==='hide'){ bar.classList.remove('show'); return; }
      if(state==='error'){ bar.classList.add('show'); bar.classList.add('error'); m.textContent = msg || 'Falha ao sincronizar. Usando dados locais.'; return; }
      bar.classList.add('show'); m.textContent = msg || 'Sincronizando com o servidor…';
    }
    function isValidRow(r){
      if(!r) return false;
      const fam = (r.family||'').toUpperCase(); const prod=(r.product||'').toUpperCase();
      const nums = ['resfriado_kg','resfriado_cx','congelado_kg','congelado_cx'];
      return fam && prod && nums.every(k => typeof r[k] === 'number' || r[k] === undefined);
    }

    async function fetchInventorySafe(signal){
      // encapsula a chamada ao Firebase exposta no window
      return await window.__fb.fbFetchAllInventory();
    }

    async function syncFromFirestore(){
      // se estiver offline, não tenta
      if(typeof navigator!=='undefined' && !navigator.onLine){ return {ok:false, offline:true}; }

      setSyncBar('show','Sincronizando com o servidor…');
      const maxAttempts = 3;
      let delay = 600; // ms
      for(let attempt=1; attempt<=maxAttempts; attempt++){
        try{
          // timeout por tentativa (7s)
          const ctl = new AbortController();
          const to = setTimeout(()=>ctl.abort(), 7000);
          const rows = await fetchInventorySafe(ctl.signal);
          clearTimeout(to);

          if(!Array.isArray(rows)) throw new Error('Resposta inesperada');

          // valida e normaliza
          const valid = rows.filter(isValidRow);
          // build novo estado server-wins
          const next = {};
          for(const fam of FAMILIAS){ next[fam.nome] = {}; } // garante famílias

          for(const r of valid){
            const family = (r.family||'').toUpperCase();
            const product = (r.product||'').toUpperCase();
            next[family] ??= {};
            next[family][product] = {
              RESFRIADO: +(r.resfriado_kg||0),
              RESFRIADO_CX: +(r.resfriado_cx||0),
              CONGELADO: +(r.congelado_kg||0),
              CONGELADO_CX: +(r.congelado_cx||0)
            };
          }

          // mantém itens padrão ausentes do servidor como 0
          for(const fam of FAMILIAS){
            for(const p of fam.itens){
              next[fam.nome][p] ??= { RESFRIADO:0, RESFRIADO_CX:0, CONGELADO:0, CONGELADO_CX:0 };
            }
          }

          // preserva itens personalizados locais que não existem no servidor (opcional)
          const local = loadStore();
          for(const [fam, produtos] of Object.entries(local||{})){
            for(const [prod, vals] of Object.entries(produtos||{})){
              if(!next[fam]) next[fam] = {};
              if(!next[fam][prod]){
                next[fam][prod] = {
                  RESFRIADO:+(vals.RESFRIADO||0),
                  RESFRIADO_CX:+(vals.RESFRIADO_CX||0),
                  CONGELADO:+(vals.CONGELADO||0),
                  CONGELADO_CX:+(vals.CONGELADO_CX||0),
                };
              }
            }
          }

          // aplica
          store = next;
          saveStore(store);
          localStorage.setItem(SYNC_META_KEY, JSON.stringify({ last_success: new Date().toISOString(), rows: valid.length }));
          setSyncBar('hide');
          return {ok:true, rows: valid.length};
        }catch(err){
          console.warn(`sync attempt ${attempt} falhou`, err);
          if(attempt < maxAttempts){
            await new Promise(r=>setTimeout(r, delay));
            delay *= 2; // backoff
          }else{
            setSyncBar('error','Falha ao sincronizar. Usando dados locais.');
            return {ok:false, error:true};
          }
        }
      }
    }

    /* ===== Topo ===== */
    document.getElementById('btnExportar').addEventListener('click', acaoGerar);
    document.getElementById('btnCompartilhar').addEventListener('click', acaoCompartilhar);
    document.getElementById('btnLimpar').addEventListener('click', ()=>{
      if(confirm('Zerar todo o estoque?')){
        store = {};
        for(const fam of FAMILIAS){
          store[fam.nome]={};
          for(const p of fam.itens) store[fam.nome][p]={RESFRIADO:0,RESFRIADO_CX:0,CONGELADO:0,CONGELADO_CX:0};
        }
        saveStore(store); render();
      }
    });

    /* ===== Bootstrap ===== */
    (async ()=>{
      await ensureLogoB64();

      // Sync robusto
      const res = await syncFromFirestore();
      // Renderiza mesmo se falhar o sync (usa local)
      render();

      // Atualiza metas após render
      FAMILIAS.forEach(f => renderHeaderMeta(f.nome));

      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      }
    })();
  </script>
</body>
</html>