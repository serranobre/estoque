<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTROLE ESTOQUE V2.1.1</title>

  <!-- mesmos assets do app de pedidos -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-title" content="Serra Nobre" />
  <meta name="theme-color" content="#f1f5f9" />

  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --muted:#64748b; --ink:#0f172a; --line:#e2e8f0;
      --fam0-soft:#eef2ff;  --fam0-strong:#6366f1;
      --fam1-soft:#ecfeff;  --fam1-strong:#06b6d4;
      --fam2-soft:#f0fdf4;  --fam2-strong:#22c55e;
      --fam3-soft:#fffbeb;  --fam3-strong:#f59e0b;
      --fam4-soft:#fef2f2;  --fam4-strong:#ef4444;
      --fam5-soft:#fdf4ff;  --fam5-strong:#a855f7;
      --fam6-soft:#f1f5f9;  --fam6-strong:#334155;
      --fam7-soft:#fff1f2;  --fam7-strong:#f43f5e;
      --fam8-soft:#f2f9f5;  --fam8-strong:#10b981;
      --fam9-soft:#f5f3ff;  --fam9-strong:#7c3aed;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--ink)}

    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;align-items:center;z-index:5;flex-wrap:wrap}
    header h1{font-size:18px;margin:0;letter-spacing:.4px}
    header .spacer{flex:1}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .wrap{max-width:980px;margin:20px auto;padding:0 12px}

    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;margin-bottom:16px;overflow:hidden}
    .fam-head{display:flex;align-items:center;gap:10px;padding:12px 14px;color:#fff;border-bottom:1px solid var(--line);flex-wrap:wrap}
    .fam-title{font-weight:900;letter-spacing:.6px;font-size:18px}
    .fam-meta{margin-left:auto;font-size:12px;opacity:.95;color:#fff}
    .fam-unit{background:#ffffff22;border:1px solid #ffffff55;border-radius:10px;padding:4px 8px;color:#fff}
    .fam-body{padding:0 12px 10px}

    .row{display:grid;grid-template-columns:1.2fr auto 0.7fr 0.65fr auto auto;gap:8px;padding:10px 8px;border-bottom:1px dashed var(--line);align-items:center;font-size:16px}
    .name{font-weight:700;text-transform:uppercase}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip-opt{border:1px solid var(--line);padding:8px 12px;border-radius:999px;background:#fff;cursor:pointer;user-select:none}
    .chip-opt.active{border-color:#111827;background:#111827;color:#fff}
    .unit select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .qty input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
    .actions{display:flex;gap:6px}
    .feedback{grid-column:1/-1;font-size:12px;color:#0f172a;padding:6px 2px 10px;min-height:18px}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .fam-0 .fam-head{background:var(--fam0-strong)} .fam-0 .fam-body .row:nth-child(even){background:var(--fam0-soft)}
    .fam-1 .fam-head{background:var(--fam1-strong)} .fam-1 .fam-body .row:nth-child(even){background:var(--fam1-soft)}
    .fam-2 .fam-head{background:var(--fam2-strong)} .fam-2 .fam-body .row:nth-child(even){background:var(--fam2-soft)}
    .fam-3 .fam-head{background:var(--fam3-strong)} .fam-3 .fam-body .row:nth-child(even){background:var(--fam3-soft)}
    .fam-4 .fam-head{background:var(--fam4-strong)} .fam-4 .fam-body .row:nth-child(even){background:var(--fam4-soft)}
    .fam-5 .fam-head{background:var(--fam5-strong)} .fam-5 .fam-body .row:nth-child(even){background:var(--fam5-soft)}
    .fam-6 .fam-head{background:var(--fam6-strong)} .fam-6 .fam-body .row:nth-child(even){background:var(--fam6-soft)}
    .fam-7 .fam-head{background:var(--fam7-strong)} .fam-7 .fam-body .row:nth-child(even){background:var(--fam7-soft)}
    .fam-8 .fam-head{background:var(--fam8-strong)} .fam-8 .fam-body .row:nth-child(even){background:var(--fam8-soft)}
    .fam-9 .fam-head{background:var(--fam9-strong)} .fam-9 .fam-body .row:nth-child(even){background:var(--fam9-soft)}

    /* busca */
    .search{display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;min-width:220px}
    .search input{border:none;outline:none;width:220px}
  </style>
</head>
<body>
  <header>
    <h1>CONTROLE ESTOQUE V2.1.1</h1>

    <div class="search">
      üîé <input id="busca" type="text" placeholder="Pesquisar produto..." />
    </div>

    <div class="spacer"></div>
    <button class="btn" id="btnLimpar">Zerar</button>
    <button class="btn" id="btnExportar">Gerar PDF</button>
    <button class="btn" id="btnXLS">Gerar XLS</button>
    <button class="btn" id="btnPosicao">Posi√ß√£o de estoque (PDF)</button>
    <button class="btn" id="btnPrecoUpload">+</button>
    <button class="btn primary" id="btnCompartilhar">Compartilhar PDF</button>
  </header>

  <div class="wrap" id="app"></div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, serverTimestamp, doc, runTransaction, collection, addDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqpE9QB9Xns655eh4HPhEDwIop0gCPEzI",
      authDomain: "estoque-serra-nobre.firebaseapp.com",
      projectId: "estoque-serra-nobre",
      storageBucket: "estoque-serra-nobre.firebasestorage.app",
      messagingSenderId: "513208551190",
      appId: "1:513208551190:web:4c7165b7887290193a7237"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    async function ensureAuth(){ if(!auth.currentUser) await signInAnonymously(auth); }
    window.__fbReady = ensureAuth();

    const invId = (family, product) => `${family}__${product}`.toUpperCase().replace(/\s+/g,' ').trim();

    async function fbAddQuantity({ family, product, tipo, unit, qty }){
      const id = invId(family, product);
      const ref = doc(db, "inventory", id);
      if(qty !== 0){
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(ref);
          let d = snap.exists() ? snap.data() : {
            family: family.toUpperCase(),
            product: product.toUpperCase(),
            resfriado_kg:0,resfriado_cx:0,resfriado_un:0,
            congelado_kg:0,congelado_cx:0,congelado_un:0
          };
          const field = `${tipo.toLowerCase()}_${unit.toLowerCase()}`;
          d[field] = +(d[field]||0) + (unit==='KG'?+qty:Math.round(+qty));
          d.updated_at = serverTimestamp();
          tx.set(ref,d,{merge:true});
        });
      }
      await addDoc(collection(db,"history"),{family,product,tipo,unit,qty,action:"ADD",at:serverTimestamp(),source:"pwa-estoque"});
    }

    async function fbZeroAllInventory(){
      const snap = await getDocs(collection(db, "inventory"));
      const batch = writeBatch(db);
      snap.forEach(d=>batch.set(d.ref,{
        resfriado_kg:0,resfriado_cx:0,resfriado_un:0,
        congelado_kg:0,congelado_cx:0,congelado_un:0,updated_at:serverTimestamp()
      },{merge:true}));
      await batch.commit();
      await addDoc(collection(db,"history"),{action:"ZERO_ALL",at:serverTimestamp(),source:"pwa-estoque"});
    }

    async function fbFetchAllInventory(){
      const snap = await getDocs(collection(db,"inventory"));
      return snap.docs.map(d=>({id:d.id,...d.data()}));
    }

    window.__fb = { fbAddQuantity, fbZeroAllInventory, fbFetchAllInventory, db };
  </script>

  <!-- App principal -->
  <script type="module">
    const APP_VERSION = "2.1.1";
    await window.__fbReady;

    /* ===== LOGO base64 ===== */
    const LOGO_KEY='estoque_logo_b64';
    const LOGO_FILE_ORDER=['Serra-Nobre_3.png','Serra-Nobre_3.webp','Serra-Nobre_3.jpg','Serra-Nobre_3.jpeg'];
    let logoB64 = localStorage.getItem(LOGO_KEY)||null;
    const blobToB64 = (blob)=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(blob);});
    async function ensureLogoB64(){ if(logoB64) return logoB64; for(const f of LOGO_FILE_ORDER){ try{const r=await fetch(f,{cache:'no-store'}); if(r.ok){logoB64=await blobToB64(await r.blob()); localStorage.setItem(LOGO_KEY,logoB64); break;}}catch{} } return logoB64; }
    async function measureImage(b64){ return new Promise((resolve,reject)=>{ if(!b64) return resolve({w:0,h:0}); const i=new Image(); i.onload=()=>resolve({w:i.naturalWidth,h:i.naturalHeight}); i.onerror=reject; i.src=b64; }); }

    /* ===== Dados est√°ticos ===== */
    const FAMILIAS = [
      { nome:"BOVINO GANCHO", itens:["CASADO GANCHO","DIANTEIRO GANCHO","COSTELA GANCHO","CHULETA GANCHO","COXA GANCHO"]},
      { nome:"BOVINO CORTES", itens:["ALCATRA","CARNE CABE√áA","CHULETA PRONTA","COX√ÉO DURO","COX√ÉO MOLE","MAMINHA","RETALHO OU NABA","VAZIO"]},
      { nome:"CAIXARIAS", itens:["CAPA DO COX√ÉO","COSTELA","COXAO FORA","COXAO MOLE","PATINHO","VAZIO"]},
      { nome:"CORDEIRO", itens:["CARR√â","COSTELA","PERNIL","PALETA","FILEZINHO"]},
      { nome:"EMBUTIDOS", itens:["BACON FATIADO","BACON MANTA","BOLINHA BORRUSSIA","CALABRESA FATIADA","CALABRESA MIGNON","CALABRESA TORTA","FRESCAL C/ PIMENTA","FRESCAL S/ PIMENTA","JUBOIA BORRUSIA","SALAME CURTO","SALAME NORMAL","SALSICHAO BORRUSSIA","SALSICHAO COLONIAL"]},
      { nome:"FRANGO", itens:["CORA√á√ÉO DE FRANGO","COXA DE FRANGO","COXA E SOBRECOXA DE FRANGO","COXA E SOBRECOXA DORSAL FRANGO","COXINHA DE FRANGO","FILE DE PEITO DE FRANGO","FRANGO INTEIRO","GALINHA VELHA","MOELA DE FRANGO","PEITO DE FRANGO COM OSSO","SOBRECOXA DE FRANGO","TULIPA DE FRANGO"]},
      { nome:"MIUDOS", itens:["CORA√á√ÉO BOVINO","FIGADO BOVINO","LINGUA BOVINA","RABADA BOVINA","CORA√á√ÉO SUINO","ORELHA SUINA","PEZINHO SUINO","RABINHO SUINO"]},
      { nome:"PEIXE", itens:["PANGA","PESCADO"]},
      { nome:"QUEIJOS", itens:["QUEIJO FATIADO","QUEIJO INTEIRO","QUEIJO COLONIAL","QUEIJO COALHO PE√áA","QUEIJO COALHO PALITO"]},
      { nome:"SUINO", itens:["CARRE SUINO","COSTELINHA SUINA","FILEZINHO SUINO","PALETA SUINA","PERNIL SUINO","SOBREPALETA SUINA"]},
    ];
    const PADROES = Object.fromEntries(FAMILIAS.map(f=>[f.nome,new Set(f.itens)]));

    /* ===== Storage ===== */
    const STORAGE_KEY="estoque_pwa_v8";
    const LAST_REPORT_KEY="estoque_last_report_v2";
    const FAMILY_UNIT_KEY="estoque_family_unit_v2";
    const PRICE_DB_KEY="estoque_price_db_v1"; // pre√ßos por item

    const $=s=>document.querySelector(s);
    const round3=n=>Math.round(n*1000)/1000;
    const fmt=n=>round3(+n||0).toLocaleString('pt-BR',{minimumFractionDigits:3,maximumFractionDigits:3});
    const iint=n=>parseInt(Math.round(+n||0));
    const pad2=n=>String(n).padStart(2,'0');
    const todayKey=()=>{const d=new Date();return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;};
    const dtLabel=(d=new Date())=>`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}`;
    const dtFileFull =(d=new Date())=>`${pad2(d.getDate())}-${pad2(d.getMonth()+1)}-${d.getFullYear()}`;
    const loadJSON=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}};
    const saveJSON=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

    let store = loadJSON(STORAGE_KEY,{});
    for(const fam of FAMILIAS){
      store[fam.nome] ??= {};
      for(const p of fam.itens){
        store[fam.nome][p] ??= { RESFRIADO:{KG:0,CX:0,UN:0}, CONGELADO:{KG:0,CX:0,UN:0}, TOUCHED_DATE:null, MOSTRAR_NO_RELATORIO:false };
      }
    }
    saveJSON(STORAGE_KEY,store);

    let familyUnit = loadJSON(FAMILY_UNIT_KEY,{});
    for(const fam of FAMILIAS){ familyUnit[fam.nome] ??= 'CX'; }
    saveJSON(FAMILY_UNIT_KEY,familyUnit);
    const unitForFamily=f=>familyUnit[f]||'CX';

    // ===== PRE√áOS =====
    let priceDB = loadJSON(PRICE_DB_KEY,{});
    const priceId = (f,p)=>`${f}__${p}`.toUpperCase().replace(/\s+/g,' ').trim();
    const getPriceKg = (f,p)=> +((priceDB[priceId(f,p)]?.price_kg)||0);
    const setPriceKg = (f,p,val)=>{ priceDB[priceId(f,p)]={price_kg:+val||0,updated_at:new Date().toISOString()}; saveJSON(PRICE_DB_KEY,priceDB); };

    /* ===== Sincroniza√ß√£o Firestore ‚Üí local ===== */
    async function syncFromServer(){
      try{
        const docs = await window.__fb.fbFetchAllInventory();
        for(const d of docs){
          const fam = String(d.family||'').toUpperCase();
          const prod= String(d.product||'').toUpperCase();
          if(!fam || !prod) continue;
          store[fam] ??= {};
          store[fam][prod] ??= { RESFRIADO:{KG:0,CX:0,UN:0}, CONGELADO:{KG:0,CX:0,UN:0}, TOUCHED_DATE:null, MOSTRAR_NO_RELATORIO:false };

          // hidrata quantidades
          store[fam][prod].RESFRIADO.KG = round3(+d.resfriado_kg||0);
          store[fam][prod].RESFRIADO.CX = iint(+d.resfriado_cx||0);
          store[fam][prod].RESFRIADO.UN = iint(+d.resfriado_un||0);
          store[fam][prod].CONGELADO.KG = round3(+d.congelado_kg||0);
          store[fam][prod].CONGELADO.CX = iint(+d.congelado_cx||0);
          store[fam][prod].CONGELADO.UN = iint(+d.congelado_un||0);

          // N√ÉO for√ßamos aparecer no relat√≥rio do dia (apenas itens digitados hoje)
          // store[fam][prod].MOSTRAR_NO_RELATORIO permanece como legado (n√£o usado nos relat√≥rios)
        }
        saveJSON(STORAGE_KEY, store);
      }catch(e){
        console.warn('Falha ao sincronizar do Firestore:', e);
      }
    }

    /* ===== Busca ===== */
    let termoBusca = '';
    $('#busca').addEventListener('input', (e)=>{ termoBusca = (e.target.value||'').trim().toUpperCase(); render(); });

    /* ===== Fun√ß√µes de dados ===== */
    function ensureEntry(familia,produto){
      store[familia] ??= {};
      store[familia][produto] ??= { RESFRIADO:{KG:0,CX:0,UN:0}, CONGELADO:{KG:0,CX:0,UN:0}, TOUCHED_DATE:null, MOSTRAR_NO_RELATORIO:false };
    }

    function totFamilia(f){
      let rk=0, ru=0, ck=0, cu=0, U=unitForFamily(f);
      Object.values(store[f]||{}).forEach(v=>{
        rk+=+v.RESFRIADO.KG||0; ru+=iint(+v.RESFRIADO[U]||0);
        ck+=+v.CONGELADO.KG||0; cu+=iint(+v.CONGELADO[U]||0);
      });
      return {rk:round3(rk), ru:iint(ru), ck:round3(ck), cu:iint(cu)};
    }
    function renderHeaderMeta(f){
      document.querySelectorAll('.card').forEach(sec=>{
        if(sec.querySelector('.fam-title')?.textContent===f){
          const t=totFamilia(f), U=unitForFamily(f);
          sec.querySelector('.fam-meta').textContent=`RESF: ${fmt(t.rk)} KG / ${t.ru} ${U} ‚Ä¢ CONG: ${fmt(t.ck)} KG / ${t.cu} ${U}`;
        }
      });
    }

    const buildUnitSelect=()=>{const s=document.createElement('select'); s.innerHTML='<option>KG</option><option>CX</option><option>UN</option>'; return s;};

    // Helpers de visibilidade
    const hasQuantity=(fam,p)=> {
      const v = store[fam]?.[p]; if(!v) return false;
      const U = unitForFamily(fam);
      return (v.RESFRIADO.KG||0)>0 || (v.CONGELADO.KG||0)>0 || (v.RESFRIADO[U]||0)>0 || (v.CONGELADO[U]||0)>0;
    };
    const touchedToday=(fam,p)=> (store[fam]?.[p]?.TOUCHED_DATE || '') === todayKey();

    /* ===== UI: linhas de produto ===== */
    function rowProduto(fam,prod){
      ensureEntry(fam,prod);
      if(termoBusca && !String(prod).toUpperCase().includes(termoBusca)) return null;

      const wrap=document.createElement('div'); wrap.className='row';
      const name=document.createElement('div'); name.className='name'; name.textContent=prod;

      const chips=document.createElement('div'); chips.className='chips';
      const cR=document.createElement('div'); cR.className='chip-opt active'; cR.textContent='RESFRIADO';
      const cC=document.createElement('div'); cC.className='chip-opt'; cC.textContent='CONGELADO';
      chips.append(cR,cC); let tipo='RESFRIADO';
      cR.onclick=()=>{tipo='RESFRIADO';cR.classList.add('active');cC.classList.remove('active')};
      cC.onclick=()=>{tipo='CONGELADO';cC.classList.add('active');cR.classList.remove('active')};

      const unit=document.createElement('div'); unit.className='unit'; const sel=buildUnitSelect(); unit.appendChild(sel);
      const qty=document.createElement('div'); qty.className='qty'; const inp=document.createElement('input'); inp.type='number'; inp.step='0.001'; inp.min='0'; inp.placeholder='Qtd'; qty.appendChild(inp);

      const add=document.createElement('button'); add.className='btn'; add.textContent='Adicionar';
      const actions=document.createElement('div'); actions.className='actions';
      const btnEdit=document.createElement('button'); btnEdit.className='btn'; btnEdit.textContent='Editar';
      const btnDel=document.createElement('button'); btnDel.className='btn'; btnDel.textContent='Excluir';
      actions.append(btnEdit,btnDel);

      const fb=document.createElement('div'); fb.className='feedback';

      add.onclick=async ()=>{
        const valStr=(inp.value||'').replace(',','.');
        if(valStr===''){ alert('Informe um n√∫mero.'); return; }
        let v = parseFloat(valStr);
        if(isNaN(v) || v<0){ alert('Valor inv√°lido.'); return; }
        const U = sel.value;
        const tgt = store[fam][prod][tipo];
        if(U==='KG') tgt[U]=round3((tgt[U]||0)+v); else tgt[U]=iint((tgt[U]||0)+v);

        // marcar como digitado hoje (independente de v ser 0 ou >0)
        store[fam][prod].TOUCHED_DATE = todayKey();

        saveJSON(STORAGE_KEY,store);
        renderHeaderMeta(fam);
        fb.textContent=`Adicionado: ${U==='KG'?fmt(v)+' KG':iint(v)+' '+U} (${tipo}).`;
        inp.value='';
        await window.__fb.fbAddQuantity({ family:fam, product:prod, tipo:tipo, unit:U, qty:v });
      };

      btnEdit.onclick=()=>{
        const U = unitForFamily(fam);
        const cur = store[fam][prod];
        const rk = prompt('RESFRIADO KG', cur.RESFRIADO.KG||0); if(rk===null) return;
        const ru = prompt(`RESFRIADO ${U}`, cur.RESFRIADO[U]||0); if(ru===null) return;
        const ck = prompt('CONGELADO KG', cur.CONGELADO.KG||0); if(ck===null) return;
        const cu = prompt(`CONGELADO ${U}`, cur.CONGELADO[U]||0); if(cu===null) return;
        cur.RESFRIADO.KG=round3(+rk||0); cur.RESFRIADO[U]=iint(+ru||0);
        cur.CONGELADO.KG=round3(+ck||0); cur.CONGELADO[U]=iint(+cu||0);

        // editar tamb√©m conta como digitado hoje
        cur.TOUCHED_DATE = todayKey();

        saveJSON(STORAGE_KEY,store); renderHeaderMeta(fam); fb.textContent='Atualizado.';
      };

      btnDel.onclick=()=>{
        const pad=PADROES[fam]?.has(prod);
        if(pad){
          if(confirm('Zerar os totais deste item?')){
            store[fam][prod]={ RESFRIADO:{KG:0,CX:0,UN:0}, CONGELADO:{KG:0,CX:0,UN:0}, TOUCHED_DATE:todayKey(), MOSTRAR_NO_RELATORIO:false };
            saveJSON(STORAGE_KEY,store); renderHeaderMeta(fam); fb.textContent='Zerado.';
          }
        }else{
          if(confirm('Remover item personalizado?')){ delete store[fam][prod]; saveJSON(STORAGE_KEY,store); wrap.remove(); renderHeaderMeta(fam); }
        }
      };

      wrap.append(name,chips,unit,qty,add,actions,fb);
      return wrap;
    }

    function rowNovoProduto(fam){
      const wrap=document.createElement('div'); wrap.className='row';
      const name=document.createElement('input'); name.placeholder='Novo produto (CAIXA ALTA)'; name.style.textTransform='uppercase';
      const chips=document.createElement('div'); chips.className='chips';
      const cR=document.createElement('div'); cR.className='chip-opt active'; cR.textContent='RESFRIADO';
      const cC=document.createElement('div'); cC.className='chip-opt'; cC.textContent='CONGELADO';
      chips.append(cR,cC); let tipo='RESFRIADO';
      cR.onclick=()=>{tipo='RESFRIADO';cR.classList.add('active');cC.classList.remove('active')}
      cC.onclick=()=>{tipo='CONGELADO';cC.classList.add('active');cR.classList.remove('active')}
      const unit=document.createElement('div'); unit.className='unit'; const sel=buildUnitSelect(); unit.appendChild(sel);
      const inp=document.createElement('input'); inp.type='number'; inp.step='0.001'; inp.min='0'; inp.placeholder='Qtd';
      const add=document.createElement('button'); add.className='btn'; add.textContent='Adicionar';
      const fb=document.createElement('div'); fb.className='feedback';

      add.onclick=async ()=>{
        const prod=(name.value||'').trim().toUpperCase();
        const valStr=(inp.value||'').replace(',','.');
        if(!prod){ alert('Digite o nome do produto.'); return; }
        if(valStr===''){ alert('Informe um n√∫mero.'); return; }
        let v=parseFloat(valStr); if(isNaN(v)||v<0){ alert('Valor inv√°lido.'); return; }
        const U=sel.value;
        ensureEntry(fam,prod);
        const tgt=store[fam][prod][tipo];
        if(U==='KG') tgt[U]=round3((tgt[U]||0)+v); else tgt[U]=iint((tgt[U]||0)+v);

        // marcado como digitado hoje
        store[fam][prod].TOUCHED_DATE = todayKey();

        saveJSON(STORAGE_KEY,store);
        const row=rowProduto(fam,prod); if(row) wrap.parentElement.insertBefore(row,wrap);
        renderHeaderMeta(fam);
        fb.textContent=`${prod} adicionado.`;
        name.value=''; inp.value='';
        await window.__fb.fbAddQuantity({ family:fam, product:prod, tipo:tipo, unit:U, qty:v });
      };

      const actions=document.createElement('div'); actions.className='actions';
      wrap.append(name,chips,unit,inp,add,actions,fb); return wrap;
    }

    function render(){
      const app=$('#app'); app.innerHTML='';
      FAMILIAS.forEach((fam,idx)=>{
        const card=document.createElement('section'); card.className=`card fam-${idx}`;
        const head=document.createElement('div'); head.className='fam-head';
        const title=document.createElement('div'); title.className='fam-title'; title.textContent=fam.nome;

        const unitSel=document.createElement('select'); unitSel.className='fam-unit'; unitSel.innerHTML=`<option value="CX">CX</option><option value="UN">UN</option>`;
        unitSel.value=unitForFamily(fam.nome);
        unitSel.onchange=()=>{ familyUnit[fam.nome]=unitSel.value; saveJSON(FAMILY_UNIT_KEY,familyUnit); render(); };

        const meta=document.createElement('div'); meta.className='fam-meta';
        const t=totFamilia(fam.nome); const U=unitForFamily(fam.nome);
        meta.textContent=`RESF: ${fmt(t.rk)} KG / ${t.ru} ${U} ‚Ä¢ CONG: ${fmt(t.ck)} KG / ${t.cu} ${U}`;

        const body=document.createElement('div'); body.className='fam-body';
        const itensFamilia=Object.keys(store[fam.nome]||{});
        const ordenados=[...new Set([...fam.itens,...itensFamilia])];
        ordenados.forEach(p=>{
          const row=rowProduto(fam.nome,p);
          if(row) body.appendChild(row);
        });
        body.appendChild(document.createElement('div')).className='divider';
        body.appendChild(rowNovoProduto(fam.nome));

        head.append(title,unitSel,meta); card.append(head,body); app.appendChild(card);
      });
    }

    // primeiro sincroniza do servidor e depois renderiza
    await syncFromServer();
    render();

    /* ===== PDF / XLS / PRE√áOS ===== */

    const PALETAS=[
      {soft:'#eef2ff',strong:'#6366f1'},{soft:'#ecfeff',strong:'#06b6d4'},
      {soft:'#f0fdf4',strong:'#22c55e'},{soft:'#fffbeb',strong:'#f59e0b'},
      {soft:'#fef2f2',strong:'#ef4444'},{soft:'#fdf4ff',strong:'#a855f7'},
      {soft:'#f1f5f9',strong:'#334155'},{soft:'#fff1f2',strong:'#f43f5e'},
      {soft:'#f2f9f5',strong:'#10b981'},{soft:'#f5f3ff',strong:'#7c3aed'}
    ];
    const hex2rgb=h=>{h=h.replace('#','');return{r:parseInt(h.slice(0,2),16),g:parseInt(h.slice(2,4),16),b:parseInt(h.slice(4,6),16)}};

    function wrap2(doc, text, xCenter, y, maxW, lh=10){
      const lines = doc.splitTextToSize(String(text).replace(/\s*\n\s*/g,'\n'), maxW).slice(0,2);
      lines.forEach((ln,i)=>doc.text(ln, xCenter, y + i*lh, {align:'center'}));
      return y + (lines.length-1)*lh;
    }

    // Snapshot (usado para "Contagem" anterior)
    function snapshot(){
      const s={};
      for(const fam of FAMILIAS){
        s[fam.nome]={};
        const U = unitForFamily(fam.nome);
        const todos = [...new Set([...fam.itens, ...Object.keys(store[fam.nome]||{})])];
        for(const p of todos){
          const v = (store[fam.nome]||{})[p] || {RESFRIADO:{KG:0,[U]:0},CONGELADO:{KG:0,[U]:0}};
          s[fam.nome][p]={
            SUM_KG: round3((v.RESFRIADO.KG||0)+(v.CONGELADO.KG||0)),
            SUM_U : iint((v.RESFRIADO[U]||0)+(v.CONGELADO[U]||0))
          };
        }
      }
      return s;
    }

    function snapshotNow(){
      const now = new Date();
      return {dateISO:now.toISOString(), dateLabel:dtLabel(now), snapshot:snapshot()};
    }

    async function baixarBlob(blob, filename){
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),60000);
    }

    // ==== PDF "Estoque do dia" ‚Üí SOMENTE itens digitados hoje ====
    function itemVisivelNoDia(fam, p){
      return touchedToday(fam,p);
    }

    async function gerarPDFBlob(){
      const { jsPDF } = window.jspdf;
      const last=loadJSON(LAST_REPORT_KEY,null);

      const doc=new jsPDF({unit:'pt', format:'a4', orientation:'landscape'});
      const W=doc.internal.pageSize.getWidth();
      const margin=36; let y=margin;

      // Logo
      await ensureLogoB64();
      if(logoB64){
        const {w,h}=await measureImage(logoB64);
        const targetW=128; const targetH=w?targetW*(h/w):128;
        doc.addImage(logoB64,(logoB64.startsWith('data:image/jpeg')?'JPEG':'PNG'),margin,y-8,targetW,targetH);
      }

      // T√≠tulo
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('ESTOQUE DO DIA', W/2, y+8, {align:'center'});
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(new Date().toLocaleString('pt-BR'), W/2, y+24, {align:'center'});
      y+=44;

      // Colunas
      const colW=160;
      const X_PROD = margin + colW*0.5;
      const X_PREV = W - margin - colW*3.5 + colW*0.5;
      const X_RESF = W - margin - colW*2.5 + colW*0.5;
      const X_CONG = W - margin - colW*1.5 + colW*0.5;
      const X_SUM  = W - margin - colW*0.5;

      let houveLinhas=false;

      for(let i=0;i<FAMILIAS.length;i++){
        const fam=FAMILIAS[i].nome;
        const pal=PALETAS[i%PALETAS.length]; const soft=hex2rgb(pal.soft); const strong=hex2rgb(pal.strong);
        const U = unitForFamily(fam);

        const base = [...new Set([...FAMILIAS[i].itens, ...Object.keys(store[fam]||{})])];
        const itens = base.filter(p=>itemVisivelNoDia(fam,p)).sort();
        if(itens.length===0) continue;

        houveLinhas=true;

        if(y>540){ doc.addPage(); y=margin; }

        // Cabe√ßalho fam√≠lia
        doc.setFillColor(soft.r,soft.g,soft.b); doc.rect(margin,y,W-margin*2,24,'F');
        doc.setTextColor(strong.r,strong.g,strong.b); doc.setFont('helvetica','bold'); doc.setFontSize(18);
        doc.text(fam, W/2, y+16, {align:'center'}); doc.setTextColor(0,0,0);
        y+=40;

        // Cabe√ßalhos
        doc.setFont('helvetica','bold'); doc.setFontSize(10);
        wrap2(doc, 'PRODUTO', X_PROD, y, colW-20);
        wrap2(doc, `${(last?.dateLabel||'ANTERIOR')}\nCONTAGEM`, X_PREV, y, colW-20);
        wrap2(doc, `RESFRIADO\n(KG / ${U})`, X_RESF, y, colW-20);
        wrap2(doc, `CONGELADO\n(KG / ${U})`, X_CONG, y, colW-20);
        wrap2(doc, `SOMA\n(KG / ${U})`, X_SUM, y, colW-20);

        y+=12; doc.line(margin,y,W-margin,y); y+=10;

        // Linhas
        doc.setFont('helvetica','normal'); doc.setFontSize(9);
        let rk=0, ru=0, ck=0, cu=0; let row=0;

        for(const p of itens){
          const v=store[fam][p], prev=last?.snapshot?.[fam]?.[p]||{SUM_KG:0,SUM_U:0};
          const sumKg=round3((v.RESFRIADO.KG||0)+(v.CONGELADO.KG||0));
          const sumU =iint((v.RESFRIADO[U]||0)+(v.CONGELADO[U]||0));

          if(y>560){ doc.addPage(); y=margin; row=0; }
          if(row%2===1){ doc.setFillColor(240,240,240); doc.rect(margin,y-10,W-margin*2,16,'F'); }

          doc.text(p, X_PROD, y, {align:'center'});
          doc.text(`${fmt(prev.SUM_KG)} / ${iint(prev.SUM_U)}`, X_PREV, y, {align:'center'});
          doc.text(`${fmt(v.RESFRIADO.KG||0)} / ${iint(v.RESFRIADO[U]||0)}`, X_RESF, y, {align:'center'});
          doc.text(`${fmt(v.CONGELADO.KG||0)} / ${iint(v.CONGELADO[U]||0)}`, X_CONG, y, {align:'center'});
          doc.text(`${fmt(sumKg)} / ${sumU}`, X_SUM, y, {align:'center'});

          y+=16; row++;
          rk+=v.RESFRIADO.KG||0; ru+=iint(v.RESFRIADO[U]||0);
          ck+=v.CONGELADO.KG||0; cu+=iint(v.CONGELADO[U]||0);
        }

        // Totais
        y+=2;
        doc.setFillColor(soft.r,soft.g,soft.b); doc.rect(margin,y-10,W-margin*2,18,'F');
        doc.setFont('helvetica','bold'); doc.setFontSize(10);
        doc.setTextColor(strong.r,strong.g,strong.b);

        const prevFam=itens.reduce((acc,p)=>{const k=last?.snapshot?.[fam]?.[p]?.SUM_KG||0; const u=last?.snapshot?.[fam]?.[p]?.SUM_U||0; return {kg:round3(acc.kg+k), un:acc.un+iint(u)};},{kg:0,un:0});
        doc.text('TOTAL', X_PROD, y, {align:'center'});
        doc.text(`${fmt(prevFam.kg)} / ${iint(prevFam.un)}`, X_PREV, y, {align:'center'});
        doc.text(`${fmt(rk)} / ${ru}`, X_RESF, y, {align:'center'});
        doc.text(`${fmt(ck)} / ${cu}`, X_CONG, y, {align:'center'});
        doc.text(`${fmt(round3(rk+ck))} / ${iint(ru+cu)}`, X_SUM, y, {align:'center'});

        doc.setTextColor(0,0,0);
        doc.setFont('helvetica','normal'); doc.setFontSize(9);
        y+=18;
      }

      if(!houveLinhas){
        doc.setFont('helvetica','italic'); doc.setFontSize(12);
        doc.text('Nenhum item digitado hoje.', W/2, y+12, {align:'center'});
      }

      return doc.output('blob');
    }

    async function gerarERegistrar(){
      await ensureLogoB64();
      const blob=await gerarPDFBlob();
      localStorage.setItem(LAST_REPORT_KEY, JSON.stringify(snapshotNow()));
      return blob;
    }

    // ==== PDF "Posi√ß√£o de estoque" (valor correto) ====
    async function gerarPosicaoEstoquePDFBlob(){
      const { jsPDF } = window.jspdf;

      const doc=new jsPDF({unit:'pt', format:'a4', orientation:'landscape'});
      const W=doc.internal.pageSize.getWidth();
      const margin=36; let y=margin;

      // Logo
      await ensureLogoB64();
      if(logoB64){
        const {w,h}=await measureImage(logoB64);
        const targetW=128; const targetH=w?targetW*(h/w):128;
        doc.addImage(logoB64,(logoB64.startsWith('data:image/jpeg')?'JPEG':'PNG'),margin,y-8,targetW,targetH);
      }

      // T√≠tulo
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('POSI√á√ÉO DE ESTOQUE ‚Äî VALOR EM R$', W/2, y+8, {align:'center'});
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(new Date().toLocaleString('pt-BR'), W/2, y+24, {align:'center'});
      y+=44;

      // 5 colunas: PRODUTO | RESFRIADO | CONGELADO | SOMA | VALOR R$
      const cols = 5;
      const colW = (W - margin*2) / cols;
      const X = (i)=> margin + colW*(i+0.5);

      for(let i=0;i<FAMILIAS.length;i++){
        const fam=FAMILIAS[i].nome;
        const pal=PALETAS[i%PALETAS.length]; const soft=hex2rgb(pal.soft); const strong=hex2rgb(pal.strong);
        const U = unitForFamily(fam);

        const base = [...new Set([...FAMILIAS[i].itens, ...Object.keys(store[fam]||{})])];
        // Posi√ß√£o de estoque ‚Üí inclui apenas itens com quantidade > 0
        const itens = base.filter(p=>hasQuantity(fam,p)).sort();
        if(itens.length===0) continue;

        if(y>540){ doc.addPage(); y=margin; }

        // Cabe√ßalho fam√≠lia
        doc.setFillColor(soft.r,soft.g,soft.b); doc.rect(margin,y,W-margin*2,24,'F');
        doc.setTextColor(strong.r,strong.g,strong.b); doc.setFont('helvetica','bold'); doc.setFontSize(18);
        doc.text(fam, W/2, y+16, {align:'center'}); doc.setTextColor(0,0,0);
        y+=40;

        // Cabe√ßalhos
        doc.setFont('helvetica','bold'); doc.setFontSize(10);
        wrap2(doc, 'PRODUTO', X(0), y, colW-20);
        wrap2(doc, `RESFRIADO\n(KG / ${U})`, X(1), y, colW-20);
        wrap2(doc, `CONGELADO\n(KG / ${U})`, X(2), y, colW-20);
        wrap2(doc, `SOMA\n(KG / ${U})`, X(3), y, colW-20);
        wrap2(doc, `VALOR\n(R$)`, X(4), y, colW-20);

        y+=12; doc.line(margin,y,W-margin,y); y+=10;

        // Linhas
        doc.setFont('helvetica','normal'); doc.setFontSize(9);
        let rk=0, ru=0, ck=0, cu=0, valorFamilia=0; let row=0;

        for(const p of itens){
          const v=store[fam][p];
          const sumKg=round3((v.RESFRIADO.KG||0)+(v.CONGELADO.KG||0));
          const sumU =iint((v.RESFRIADO[U]||0)+(v.CONGELADO[U]||0));
          const precoKg = +getPriceKg(fam,p);
          const valor = (sumKg * (precoKg||0)); // c√°lculo sem arredondar antes
          valorFamilia += valor;

          if(y>560){ doc.addPage(); y=margin; row=0; }
          if(row%2===1){ doc.setFillColor(240,240,240); doc.rect(margin,y-10,W-margin*2,16,'F'); }

          doc.text(p, X(0), y, {align:'center'});
          doc.text(`${fmt(v.RESFRIADO.KG||0)} / ${iint(v.RESFRIADO[U]||0)}`, X(1), y, {align:'center'});
          doc.text(`${fmt(v.CONGELADO.KG||0)} / ${iint(v.CONGELADO[U]||0)}`, X(2), y, {align:'center'});
          doc.text(`${fmt(sumKg)} / ${sumU}`, X(3), y, {align:'center'});
          doc.text((valor||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}), X(4), y, {align:'center'});

          y+=16; row++;
          rk+=v.RESFRIADO.KG||0; ru+=iint(v.RESFRIADO[U]||0);
          ck+=v.CONGELADO.KG||0; cu+=iint(v.CONGELADO[U]||0);
        }

        // Totais
        y+=2;
        doc.setFillColor(soft.r,soft.g,soft.b); doc.rect(margin,y-10,W-margin*2,18,'F');
        doc.setFont('helvetica','bold'); doc.setFontSize(10);
        doc.setTextColor(strong.r,strong.g,strong.b);

        doc.text('TOTAL', X(0), y, {align:'center'});
        doc.text(`${fmt(rk)} / ${ru}`, X(1), y, {align:'center'});
        doc.text(`${fmt(ck)} / ${cu}`, X(2), y, {align:'center'});
        doc.text(`${fmt(round3(rk+ck))} / ${iint(ru+cu)}`, X(3), y, {align:'center'});
        doc.text((valorFamilia||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}), X(4), y, {align:'center'});

        doc.setTextColor(0,0,0);
        doc.setFont('helvetica','normal'); doc.setFontSize(9);
        y+=18;
      }

      return doc.output('blob');
    }

    // ==== XLS (apenas itens digitados hoje, como o PDF do dia) ====
    function gerarXLSBlob(){
      const last=loadJSON(LAST_REPORT_KEY,null);
      let html = `
      <html><head><meta charset="UTF-8"></head><body>
      <table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse;font-family:Arial">
        <tr style="font-weight:bold;text-align:center;background:#eee">
          <td>FAM√çLIA</td>
          <td>PRODUTO</td>
          <td>${(last?.dateLabel||'ANTERIOR')}<br/>CONTAGEM</td>
          <td>RESFRIADO<br/>(KG / UN)</td>
          <td>CONGELADO<br/>(KG / UN)</td>
          <td>SOMA<br/>(KG / UN)</td>
        </tr>`;

      for(const famObj of FAMILIAS){
        const fam = famObj.nome;
        const U = unitForFamily(fam);
        const base = [...new Set([...famObj.itens, ...Object.keys(store[fam]||{})])];
        const itens = base.filter(p=>touchedToday(fam,p)).sort();
        if(itens.length===0) continue;

        for(const p of itens){
          const v=store[fam][p], prev=last?.snapshot?.[fam]?.[p]||{SUM_KG:0,SUM_U:0};
          const sumKg=round3((v.RESFRIADO.KG||0)+(v.CONGELADO.KG||0));
          const sumU =iint((v.RESFRIADO[U]||0)+(v.CONGELADO[U]||0));
          html += `
            <tr style="text-align:center">
              <td>${fam}</td>
              <td>${p}</td>
              <td>${fmt(prev.SUM_KG)} / ${iint(prev.SUM_U)}</td>
              <td>${fmt(v.RESFRIADO.KG||0)} / ${iint(v.RESFRIADO[U]||0)}</td>
              <td>${fmt(v.CONGELADO.KG||0)} / ${iint(v.CONGELADO[U]||0)}</td>
              <td>${fmt(sumKg)} / ${sumU}</td>
            </tr>`;
        }

        // Totais por fam√≠lia (apenas dos itens do dia)
        let rk=0,ru=0,ck=0,cu=0;
        for(const p of itens){
          const v=store[fam][p];
          rk+=v.RESFRIADO.KG||0; ru+=iint(v.RESFRIADO[U]||0);
          ck+=v.CONGELADO.KG||0; cu+=iint(v.CONGELADO[U]||0);
        }
        const prevFam=itens.reduce((acc,p)=>{const k=last?.snapshot?.[fam]?.[p]?.SUM_KG||0; const u=last?.snapshot?.[fam]?.[p]?.SUM_U||0; return {kg:round3(acc.kg+k), un:acc.un+iint(u)};},{kg:0,un:0});
        html += `
          <tr style="font-weight:bold;text-align:center;background:#f6f6f6">
            <td colspan="2">TOTAL ${fam}</td>
            <td>${fmt(prevFam.kg)} / ${iint(prevFam.un)}</td>
            <td>${fmt(round3(rk))} / ${iint(ru)}</td>
            <td>${fmt(round3(ck))} / ${iint(cu)}</td>
            <td>${fmt(round3(rk+ck))} / ${iint(ru+cu)}</td>
          </tr>`;
      }

      html += `</table></body></html>`;
      return new Blob([html], {type:'application/vnd.ms-excel'});
    }

    // ==== Modelo XLSX de pre√ßos + leitura/atualiza√ß√£o ====
    function gerarModeloPrecosXLSBlob(){
      const wb = XLSX.utils.book_new();
      const linhas = [["FAMILIA","PRODUTO","PRECO_KG"]];
      for(const f of FAMILIAS){
        const todos=[...new Set([...f.itens, ...Object.keys(store[f.nome]||{})])].sort();
        for(const p of todos){
          const atual = getPriceKg(f.nome,p) || '';
          linhas.push([f.nome, p, atual]);
        }
      }
      const ws = XLSX.utils.aoa_to_sheet(linhas);
      ws['!cols'] = [{wch:25},{wch:35},{wch:12}];
      XLSX.utils.book_append_sheet(wb, ws, 'PRECOS');
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      return new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    }

    async function lerXLSPrecosAtualizar(file){
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
      const header = rows[0].map(h=>String(h).trim().toUpperCase());
      const idxFam = header.indexOf('FAMILIA');
      const idxProd= header.indexOf('PRODUTO');
      const idxPreco=header.indexOf('PRECO_KG');
      if(idxFam===-1 || idxProd===-1 || idxPreco===-1){
        alert('Planilha inv√°lida. Cabe√ßalhos esperados: FAMILIA | PRODUTO | PRECO_KG');
        return;
      }
      let atualizados=0;
      for(let i=1;i<rows.length;i++){
        const r = rows[i];
        const fam = String(r[idxFam]||'').toUpperCase().trim();
        const prod= String(r[idxProd]||'').toUpperCase().trim();
        const preco = parseFloat(String(r[idxPreco]).replace(',','.'));
        if(!fam || !prod || isNaN(preco)) continue;
        setPriceKg(fam, prod, preco);
        atualizados++;
      }
      alert(`${atualizados} pre√ßo(s) atualizado(s).`);
    }

    /* ===== Bot√µes topo ===== */
    document.getElementById('btnExportar').onclick=async ()=>{
      const blob=await gerarERegistrar();
      await baixarBlob(blob, `ESTOQUE ${dtFileFull(new Date())}.pdf`);
    };

    document.getElementById('btnCompartilhar').onclick=async ()=>{
      const blob=await gerarERegistrar();
      const fname=`ESTOQUE ${dtFileFull(new Date())}.pdf`;
      const file=new File([blob],fname,{type:'application/pdf'});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        try{ await navigator.share({files:[file],title:'Estoque',text:'Relat√≥rio de estoque'});}catch(e){}
      }else{
        await baixarBlob(blob, fname);
      }
    };

    document.getElementById('btnXLS').onclick=()=>{
      const blob=gerarXLSBlob();
      const fname=`ESTOQUE ${dtFileFull(new Date())}.xls`;
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),60000);
    };

    document.getElementById('btnPosicao').onclick=async ()=>{
      const blob=await gerarPosicaoEstoquePDFBlob();
      await baixarBlob(blob, `POSI√á√ÉO ESTOQUE ${dtFileFull(new Date())}.pdf`);
    };

    // Upload / Modelo de pre√ßos
    const inputUpload=document.createElement('input'); inputUpload.type='file'; inputUpload.accept='.xlsx,.xls'; inputUpload.style.display='none'; document.body.appendChild(inputUpload);

    document.getElementById('btnPrecoUpload').onclick=async ()=>{
      const querModelo = confirm('OK para baixar o modelo de pre√ßos.\nCancelar para enviar uma planilha.');
      if(querModelo){
        const blob=gerarModeloPrecosXLSBlob();
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`MODELO_PRECOS_${dtFileFull(new Date())}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url),60000);
      }else{
        inputUpload.click();
      }
    };

    inputUpload.onchange=async (ev)=>{
      const file = ev.target.files?.[0];
      if(!file) return;
      try{
        await lerXLSPrecosAtualizar(file);
      }catch(e){
        console.error(e);
        alert('Falha ao processar a planilha de pre√ßos.');
      }finally{
        inputUpload.value='';
      }
    };

    // Zerar total (local + servidor)
    document.getElementById('btnLimpar').onclick=async ()=>{
      if(!confirm('Zerar todo o estoque (dispositivo + servidor)?')) return;

      const last = loadJSON(LAST_REPORT_KEY,null);

      try{ await window.__fb.fbZeroAllInventory(); }catch(e){ console.warn('Falha ao zerar Firestore:',e); }

      for(const fam of FAMILIAS){
        for(const p of Object.keys(store[fam.nome]||{})){
          store[fam.nome][p]={ RESFRIADO:{KG:0,CX:0,UN:0}, CONGELADO:{KG:0,CX:0,UN:0}, TOUCHED_DATE:todayKey(), MOSTRAR_NO_RELATORIO:false };
        }
      }

      // Mantemos o snapshot anterior para compara√ß√£o quando itens forem recontados
      if(last?.snapshot){
        // nada a for√ßar para relat√≥rio do dia, pois ele filtra por TOUCHED_DATE
      }

      saveJSON(STORAGE_KEY,store);
      render();
      alert('Estoque zerado. O relat√≥rio anterior continuar√° dispon√≠vel como refer√™ncia na coluna "Contagem" quando voc√™ digitar novamente.');
    };

    /* ===== For√ßar atualiza√ß√£o (SW) ===== */
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').then(async reg=>{
        try{
          await reg.update();
          if(reg.waiting){
            reg.waiting.postMessage({type:'SKIP_WAITING'});
          }
          if(navigator.serviceWorker.controller){
            navigator.serviceWorker.addEventListener('controllerchange', ()=>location.reload());
          }
        }catch(e){}
      }).catch(()=>{});
    }
  </script>
</body>
</html>
