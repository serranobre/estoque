<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTROLE DE ESTOQUE SERRA NOBRE</title>

  <!-- Ícones iguais ao app de pedidos -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-title" content="Serra Nobre" />
  <meta name="theme-color" content="#f1f5f9" />

  <style>
    :root{
      --bg:#f7fafc; --card:#ffffff; --muted:#64748b; --ink:#0f172a; --line:#e2e8f0;
      --fam0-soft:#eef2ff;  --fam0-strong:#6366f1;
      --fam1-soft:#ecfeff;  --fam1-strong:#06b6d4;
      --fam2-soft:#f0fdf4;  --fam2-strong:#22c55e;
      --fam3-soft:#fffbeb;  --fam3-strong:#f59e0b;
      --fam4-soft:#fef2f2;  --fam4-strong:#ef4444;
      --fam5-soft:#fdf4ff;  --fam5-strong:#a855f7;
      --fam6-soft:#f1f5f9;  --fam6-strong:#334155;
      --fam7-soft:#fff1f2;  --fam7-strong:#f43f5e;
      --fam8-soft:#f2f9f5;  --fam8-strong:#10b981;
      --fam9-soft:#f5f3ff;  --fam9-strong:#7c3aed;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--ink)}

    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;align-items:center;z-index:5}
    header h1{font-size:18px;margin:0;letter-spacing:.5px}
    header .spacer{flex:1}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}

    .wrap{max-width:980px;margin:20px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;margin-bottom:16px;overflow:hidden}
    .fam-head{display:flex;align-items:center;gap:10px;padding:12px 14px;color:#fff;border-bottom:1px solid var(--line)}
    .fam-title{font-weight:900;letter-spacing:.6px;font-size:18px}
    .fam-meta{margin-left:auto;font-size:12px;opacity:.9;color:#fff}
    .fam-body{padding:0 12px 10px}

    .row{display:grid;grid-template-columns: 1.2fr auto 0.7fr 0.6fr auto auto;gap:8px;padding:10px 8px;border-bottom:1px dashed var(--line);align-items:center;font-size:16px}
    .name{font-weight:700;text-transform:uppercase}
    .chips{display:flex;gap:8px}
    .chip-opt{border:1px solid var(--line);padding:8px 12px;border-radius:999px;background:#fff;cursor:pointer}
    .chip-opt.active{background:#111827;color:#fff}
    .unit select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
    .qty input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
    .actions{display:flex;gap:6px}
    .feedback{grid-column:1/-1;font-size:12px;color:#0f172a;padding:6px 2px 10px}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .fam-0 .fam-head{background:var(--fam0-strong)}
    .fam-1 .fam-head{background:var(--fam1-strong)}
    .fam-2 .fam-head{background:var(--fam2-strong)}
    .fam-3 .fam-head{background:var(--fam3-strong)}
    .fam-4 .fam-head{background:var(--fam4-strong)}
    .fam-5 .fam-head{background:var(--fam5-strong)}
    .fam-6 .fam-head{background:var(--fam6-strong)}
    .fam-7 .fam-head{background:var(--fam7-strong)}
    .fam-8 .fam-head{background:var(--fam8-strong)}
    .fam-9 .fam-head{background:var(--fam9-strong)}
  </style>
</head>
<body>
  <header>
    <h1>CONTROLE DE ESTOQUE SERRA NOBRE</h1>
    <div class="spacer"></div>
    <button class="btn" id="btnLimpar">Zerar</button>
    <button class="btn" id="btnExportar">Gerar PDF</button>
    <button class="btn primary" id="btnCompartilhar">Compartilhar PDF</button>
  </header>

  <div class="wrap" id="app"></div>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, serverTimestamp, doc, runTransaction, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqpE9QB9Xns655eh4HPhEDwIop0gCPEzI",
      authDomain: "estoque-serra-nobre.firebaseapp.com",
      projectId: "estoque-serra-nobre",
      storageBucket: "estoque-serra-nobre.firebasestorage.app",
      messagingSenderId: "513208551190",
      appId: "1:513208551190:web:4c7165b7887290193a7237"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function ensureAuth(){
      if(!auth.currentUser) await signInAnonymously(auth);
      return auth.currentUser?.uid||null;
    }
    window.__fbReady = ensureAuth();

    function invId(f,p){return `${f}__${p}`.toUpperCase().trim();}

    async function fbAddQuantity({family,product,tipo,unit,qty}){
      const id=invId(family,product); const ref=doc(db,"inventory",id);
      await runTransaction(db,async(tx)=>{
        const snap=await tx.get(ref);
        let d=snap.exists()?snap.data():{family,product,resfriado_kg:0,resfriado_cx:0,resfriado_un:0,congelado_kg:0,congelado_cx:0,congelado_un:0};
        const key=`${tipo.toLowerCase()}_${unit.toLowerCase()}`;
        d[key]=(d[key]||0)+qty; d.updated_at=serverTimestamp();
        tx.set(ref,d,{merge:true});
      });
      await addDoc(collection(db,"history"),{family,product,tipo,unit,qty,action:"ADD",at:serverTimestamp()});
    }
    async function fbFetchAllInventory(){
      const snap=await getDocs(collection(db,"inventory"));
      return snap.docs.map(d=>({id:d.id,...d.data()}));
    }
    window.__fb={fbAddQuantity,fbFetchAllInventory};
  </script>

  <!-- App -->
  <script type="module">
    await window.__fbReady;

    const FAMILIAS=[{nome:"BOVINO GANCHO",itens:["CASADO GANCHO","DIANTEIRO GANCHO"]},{nome:"BOVINO CORTES",itens:["CARNE CABEÇA","CHULETA PRONTA"]}];
    const STORAGE_KEY="estoque_pwa"; let store={};
    const $=s=>document.querySelector(s); const fmt=n=>(Math.round(n*1000)/1000).toLocaleString('pt-BR',{minimumFractionDigits:3});
    function loadStore(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||{}}catch{return{}}}
    function saveStore(){localStorage.setItem(STORAGE_KEY,JSON.stringify(store))}
    store=loadStore();

    function rowProduto(fam,prod){
      store[fam]??={}; store[fam][prod]??={RESFRIADO:{},CONGELADO:{}};
      const wrap=document.createElement("div"); wrap.className="row";
      const name=document.createElement("div"); name.className="name"; name.textContent=prod;
      const chips=document.createElement("div"); chips.className="chips";
      let selTipo="RESFRIADO"; const optR=document.createElement("div"); optR.className="chip-opt active"; optR.textContent="RESFRIADO";
      const optC=document.createElement("div"); optC.className="chip-opt"; optC.textContent="CONGELADO";
      chips.append(optR,optC); optR.onclick=()=>{selTipo="RESFRIADO";optR.classList.add("active");optC.classList.remove("active")}; optC.onclick=()=>{selTipo="CONGELADO";optC.classList.add("active");optR.classList.remove("active")};
      const unitDiv=document.createElement("div"); unitDiv.className="unit"; const sel=document.createElement("select"); sel.innerHTML="<option>KG</option><option>CX</option><option>UN</option>"; unitDiv.appendChild(sel);
      const qty=document.createElement("div"); qty.className="qty"; const inp=document.createElement("input"); inp.type="number"; inp.step="0.001"; inp.placeholder="Qtd"; qty.appendChild(inp);
      const add=document.createElement("button"); add.className="btn"; add.textContent="Adicionar";
      add.onclick=async()=>{const v=parseFloat(inp.value); if(isNaN(v)||v<=0)return; const u=sel.value; store[fam][prod][selTipo][u]=(store[fam][prod][selTipo][u]||0)+v; saveStore(); await window.__fb.fbAddQuantity({family:fam,product:prod,tipo:selTipo,unit:u,qty:v}); inp.value=""}
      wrap.append(name,chips,unitDiv,qty,add); return wrap;
    }

    function render(){const app=$("#app");app.innerHTML="";FAMILIAS.forEach((f,i)=>{const card=document.createElement("section");card.className=`card fam-${i}`;const head=document.createElement("div");head.className="fam-head";head.innerHTML=`<div class="fam-title">${f.nome}</div>`;const body=document.createElement("div");body.className="fam-body";f.itens.forEach(p=>body.appendChild(rowProduto(f.nome,p)));card.append(head,body);app.appendChild(card)})}
    render();

    async function gerarPDF(){
      const {jsPDF}=window.jspdf;const doc=new jsPDF({unit:"pt",format:"a4"});
      const W=doc.internal.pageSize.getWidth();let y=40;
      if(logoB64){const isJPEG=logoB64.startsWith("data:image/jpeg");doc.addImage(logoB64,isJPEG?"JPEG":"PNG",40,y,64*3,64*3);}
      doc.setFontSize(16);doc.text("ESTOQUE DO DIA",W/2,y,{align:"center"});
      y+=100;
      FAMILIAS.forEach(f=>{y+=20;doc.setFontSize(14);doc.text(f.nome,W/2,y,{align:"center"});y+=20;doc.setFontSize(10);
        doc.text("PRODUTO",40,y);doc.text("ANTERIOR\nCONTAGEM",150,y);doc.text("RESFRIADO\n(KG/CX/UN)",300,y);doc.text("CONGELADO\n(KG/CX/UN)",450,y);doc.text("SOMA\nESTOQUE",600,y);y+=30;
        Object.keys(store[f.nome]||{}).forEach(p=>{doc.text(p,40,y);y+=20;});
      });
      return doc.output("blob");
    }

    let logoB64=null;async function ensureLogoB64(){if(logoB64)return;try{const r=await fetch("Serra-Nobre_3.png");logoB64=await r.blob().then(b=>new Promise(res=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.readAsDataURL(b);}));}catch{}}
    async function abrirPDFEmAba(b){const u=URL.createObjectURL(b);window.open(u,"_blank");setTimeout(()=>URL.revokeObjectURL(u),6e4)}
    $("#btnExportar").onclick=async()=>{await ensureLogoB64();const b=await gerarPDF();abrirPDFEmAba(b);}
    $("#btnCompartilhar").onclick=async()=>{await ensureLogoB64();const b=await gerarPDF();abrirPDFEmAba(b);}
    $("#btnLimpar").onclick=()=>{if(confirm("Zerar?")){store={};saveStore();render();}}
  </script>
</body>
</html>